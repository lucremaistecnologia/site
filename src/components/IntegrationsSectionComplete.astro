---
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";

// Importações de logos
import GoogleLogo from "../../public/logos/google.svg";
import Membros from "../../public/logos/membros.svg";
import Conversao from "../../public/logos/conversão.svg";
import Checkout from "../../public/logos/checkout.svg";
import Automation from "../../public/logos/automation.svg";

// Logos específicos para cada categoria
import Cademi from "../../public/logos/cademi.png";
import Memberkit from "../../public/logos/memberkit.svg";
import Mentorfy from "../../public/logos/mentorfy.png";
import Themembers from "../../public/logos/themembers.png";
import Facebook from "../../public/logos/facebook.png";
import Outbrain from "../../public/logos/outbrain.png";
import Notazz from "../../public/logos/notazz.png";
import Contaazul from "../../public/logos/contaazul.png";
import Enotas from "../../public/logos/enotas.png";
import Hubspot from "../../public/logos/hubspot.svg";
import AlpaClass from "../../public/logos/AlpaClass.png";
import AppSell from "../../public/logos/AppSell.png";
import AstronMembers from "../../public/logos/Astron members.svg";
import Builderall from "../../public/logos/Builderall.png";
import Circle from "../../public/logos/circle.svg";
import Curseduca from "../../public/logos/Curseduca.png";
import EadPlataforma from "../../public/logos/Ead plataforma.png";
import Eduvem from "../../public/logos/eduvem.png";
import Entregadigital from "../../public/logos/entregadigital.svg";
import EscolaAvancada from "../../public/logos/Escola avançada.png";
import GoogleLogoSvg from "../../public/logos/google-logo.svg";
import Herospark from "../../public/logos/Herospark.png";
import Hiiatus from "../../public/logos/hiiatus.svg";
import Hotscool from "../../public/logos/hotscool.png";
import HubspotCompleto from "../../public/logos/hubspotCompleto.svg";
import Kajabi from "../../public/logos/kajabi.png";
import Leadlovers from "../../public/logos/leadlovers.png";
import Learnworlds from "../../public/logos/learnworlds.png";
import Logotoolzz from "../../public/logos/logotoolzz.svg";
import MemberHub from "../../public/logos/member hub.png";
import Moodle from "../../public/logos/moodle.png";
import Systeme from "../../public/logos/systeme.png";
import Thinkific from "../../public/logos/thinkific.svg";
import WixLogo from "../../public/logos/wix-logo.png";

interface LogoItem {
  src: ImageMetadata;
  alt: string;
  name: string;
}

interface IntegrationCategory {
  title: string;
  logos: LogoItem[];
}

const integrationCategories: IntegrationCategory[] = [
  {
    title: "Áreas de Membro",
    logos: [
      { src: Circle, alt: "Circle Logo", name: "Circle" },
      { src: WixLogo, alt: "Wix Logo", name: "Wix" },
      { src: Thinkific, alt: "Thinkific Logo", name: "Thinkific" },
      { src: Logotoolzz, alt: "Toolzz Logo", name: "Toolzz" },
      { src: Systeme, alt: "Systeme Logo", name: "Systeme" },
      { src: Moodle, alt: "Moodle Logo", name: "Moodle" },
      { src: Memberkit, alt: "Memberkit Logo", name: "memberkit" },
      { src: Learnworlds, alt: "LearnWorlds Logo", name: "LearnWorlds" },
      { src: Leadlovers, alt: "Leadlovers Logo", name: "Leadlovers" },
      { src: Membros, alt: "Clickmembers Logo", name: "Clickmembers" },
      { src: Kajabi, alt: "Kajabi Logo", name: "Kajabi" },
      { src: Hotscool, alt: "Hotscool Logo", name: "Hotscool" },
      { src: Herospark, alt: "Herospark Logo", name: "Herospark" },
      { src: Eduvem, alt: "Eduvem Logo", name: "eduvem" },
      {
        src: EadPlataforma,
        alt: "Ead plataforma Logo",
        name: "Ead plataforma",
      },
      { src: AlpaClass, alt: "AlpaClass Logo", name: "AlpaClass" },
      { src: Themembers, alt: "The Members Logo", name: "The Members" },
      { src: Mentorfy, alt: "Mentorfy Logo", name: "Mentorfy" },
      { src: Membros, alt: "Memberbox Logo", name: "Memberbox" },
      { src: MemberHub, alt: "Member Hub Logo", name: "Member Hub" },
      { src: Hiiatus, alt: "Hiiatus Logo", name: "hiiatus" },
      {
        src: EscolaAvancada,
        alt: "Escola avançada Logo",
        name: "Escola avançada",
      },
      {
        src: Entregadigital,
        alt: "Entrega digital Logo",
        name: "Entrega digital",
      },
      { src: Curseduca, alt: "Curseduca Logo", name: "Curseduca" },
      { src: Cademi, alt: "Cademí Logo", name: "Cademí" },
      { src: Builderall, alt: "Builderall Logo", name: "Builderall" },
      { src: Membros, alt: "Blix stream Logo", name: "Blix stream" },
      {
        src: AstronMembers,
        alt: "Astron members Logo",
        name: "Astron members",
      },
      { src: AppSell, alt: "AppSell Logo", name: "AppSell" },
    ],
  },
  {
    title: "Dados de Conversão",
    logos: [
      { src: Facebook, alt: "Facebook Logo", name: "Facebook" },
      { src: GoogleLogo, alt: "Google Logo", name: "Google" },
      { src: Conversao, alt: "Linked In Logo", name: "Linked In" },
      { src: Outbrain, alt: "Outbrain Logo", name: "Outbrain" },
      { src: Conversao, alt: "Taboola Logo", name: "Taboola" },
    ],
  },
  {
    title: "Recuperação de Vendas",
    logos: [
      { src: Checkout, alt: "Hotzapp Logo", name: "Hotzapp" },
      { src: Checkout, alt: "Konvert Logo", name: "Konvert" },
      {
        src: Checkout,
        alt: "Notificações inteligentes Logo",
        name: "Notificações inteligentes",
      },
      { src: Checkout, alt: "Boleto recovery Logo", name: "Boleto recovery" },
      { src: Checkout, alt: "Recup.in Logo", name: "Recup.in" },
      { src: Checkout, alt: "Reportana Logo", name: "Reportana" },
      { src: Checkout, alt: "SAK Logo", name: "SAK" },
      { src: Checkout, alt: "SellFlux Logo", name: "SellFlux" },
      { src: Checkout, alt: "SocialHub Logo", name: "SocialHub" },
      { src: Checkout, alt: "PlugLead Logo", name: "PlugLead" },
      { src: Checkout, alt: "Varela Logo", name: "Varela" },
    ],
  },
  {
    title: "Automações",
    logos: [
      { src: Automation, alt: "Certiflink Logo", name: "Certiflink" },
      { src: Automation, alt: "Clint Logo", name: "Clint" },
      { src: Automation, alt: "Botconversa Logo", name: "Botconversa" },
      { src: Automation, alt: "Devzapp Logo", name: "Devzapp" },
      { src: Automation, alt: "LeadTracker Logo", name: "LeadTracker" },
      { src: Automation, alt: "Linkseller Logo", name: "Linkseller" },
      { src: Automation, alt: "Pluga Logo", name: "Pluga" },
      { src: Automation, alt: "Voxuy Logo", name: "Voxuy" },
      { src: Automation, alt: "WiiChat Logo", name: "WiiChat" },
    ],
  },
  {
    title: "E-mail Marketing e CRM",
    logos: [
      { src: GoogleLogo, alt: "ActiveCampaing Logo", name: "ActiveCampaing" },
      { src: GoogleLogo, alt: "AgileCRM Logo", name: "AgileCRM" },
      { src: GoogleLogo, alt: "Brevo Logo", name: "Brevo" },
      { src: GoogleLogo, alt: "Closum Logo", name: "Closum" },
      {
        src: GoogleLogo,
        alt: "Constant Contact Logo",
        name: "Constant Contact",
      },
      { src: GoogleLogo, alt: "ConvertKit Logo", name: "ConvertKit" },
      { src: GoogleLogo, alt: "Dinamize Logo", name: "Dinamize" },
      { src: GoogleLogo, alt: "e-goi Logo", name: "e-goi" },
      { src: GoogleLogo, alt: "GetResponse Logo", name: "GetResponse" },
      { src: GoogleLogo, alt: "green Sales Logo", name: "green Sales" },
      { src: Hubspot, alt: "Hubspot Logo", name: "Hubspot" },
      { src: GoogleLogo, alt: "Klicksend Logo", name: "Klicksend" },
      { src: GoogleLogo, alt: "Leadlovers Logo", name: "Leadlovers" },
      { src: GoogleLogo, alt: "Mailchimp Logo", name: "Mailchimp" },
      { src: GoogleLogo, alt: "Mailee Logo", name: "Mailee" },
      { src: GoogleLogo, alt: "Nitronews Logo", name: "Nitronews" },
      { src: GoogleLogo, alt: "RD Station Logo", name: "RD Station" },
      { src: GoogleLogo, alt: "Salesforce Logo", name: "Salesforce" },
      { src: GoogleLogo, alt: "SendGrid Logo", name: "SendGrid" },
      { src: GoogleLogo, alt: "SendPulse Logo", name: "SendPulse" },
      { src: GoogleLogo, alt: "ActiveCampaign Logo", name: "ActiveCampaign" },
    ],
  },
  {
    title: "Emissão de Notas Fiscais",
    logos: [
      { src: Enotas, alt: "Enotas Logo", name: "Enotas" },
      { src: Notazz, alt: "Notazz Logo", name: "Notazz" },
      { src: Notazz, alt: "Bling Logo", name: "Bling" },
      { src: Notazz, alt: "Omie Logo", name: "Omie" },
      { src: Notazz, alt: "Digisan Logo", name: "Digisan" },
      { src: Notazz, alt: "Invoicexpress Logo", name: "Invoicexpress" },
      { src: Notazz, alt: "Tiny Logo", name: "Tiny" },
      { src: Notazz, alt: "luli Logo", name: "luli" },
      { src: Notazz, alt: "Spedy Logo", name: "Spedy" },
      { src: Notazz, alt: "IziBizi Logo", name: "IziBizi" },
      { src: Notazz, alt: "vhsys Logo", name: "vhsys" },
      { src: Notazz, alt: "Smartnotas Logo", name: "Smartnotas" },
      { src: Contaazul, alt: "Conta Azul Logo", name: "Conta Azul" },
      { src: Notazz, alt: "moloni Logo", name: "moloni" },
      { src: Notazz, alt: "biu Logo", name: "biu" },
      { src: Notazz, alt: "Zuppy Logo", name: "Zuppy" },
    ],
  },
];

const jsIntegrationCategories = integrationCategories.map((category) => ({
  title: category.title,
  logos: category.logos.map((logo) => ({
    src: logo.src.src,
    alt: logo.alt,
    name: logo.name,
  })),
}));

const initialCategory = jsIntegrationCategories[0];
---

<section
  class="integrations-section highlight-section"
  id="integrations-section-complete"
>
  <div class="highlight-content">
    <!-- Desktop: Image container visible -->
    <div class="highlight-image-container desktop-only">
      <div class="integration-logos-grid" id="integration-logos-grid">
        {
          initialCategory.logos.map((logo) => (
            <div class="logo-block">
              <div class="logo-image">
                <img src={logo.src} alt={logo.alt} class="logo-vector" />
              </div>
              <span>{logo.name}</span>
            </div>
          ))
        }
      </div>
    </div>

    <div class="highlight-details">
      <h2 class="highlight-main-title">Integrações estratégicas</h2>
      <p class="subtitle">Confira nossas principais integrações estratégicas</p>
      <ul
        class="highlight-list"
        data-integration-categories={JSON.stringify(jsIntegrationCategories)}
        data-initial-category={JSON.stringify(initialCategory)}
      >
        {
          integrationCategories.map((category, index) => (
            <li data-index={index} class:list={{ active: index === 0 }}>
              {category.title}
            </li>
          ))
        }
      </ul>
    </div>
  </div>

  <!-- Mobile: Modal structure -->
  <div id="integrations-modal" class="integrations-modal mobile-only">
    <div class="integrations-modal-content">
      <span class="integrations-modal-close">&times;</span>
      <div class="integration-logos-grid" id="integration-logos-grid-mobile">
        <!-- Mobile logos will be injected here by the script -->
      </div>
    </div>
  </div>
</section>

<script client:load>
  document.addEventListener("astro:page-load", () => {
    const highlightList = document.querySelector(".highlight-list");
    if (!highlightList) return;

    const jsIntegrationCategories = JSON.parse(
      highlightList.dataset.integrationCategories || "[]"
    );
    const initialCategory = JSON.parse(
      highlightList.dataset.initialCategory || "{}"
    );

    setupIntegrationsSection(jsIntegrationCategories, initialCategory);
  });

  function setupIntegrationsSection(categories, initialCat) {
    const listItems = document.querySelectorAll(".highlight-list li");
    const integrationLogosGrid = document.getElementById(
      "integration-logos-grid"
    );
    const integrationLogosGridMobile = document.getElementById(
      "integration-logos-grid-mobile"
    );
    const modal = document.getElementById("integrations-modal");
    const closeModal = document.querySelector(".integrations-modal-close");

    if (
      !integrationLogosGrid ||
      !modal ||
      !closeModal ||
      !integrationLogosGridMobile
    ) {
      console.error("Required elements for integrations section not found.");
      return;
    }

    const renderLogos = (categoryToDisplay, grid) => {
      if (!grid) return;
      grid.innerHTML = ""; // Clear existing logos
      categoryToDisplay.logos.forEach((logo) => {
        const logoBlock = document.createElement("div");
        logoBlock.classList.add("logo-block");

        const logoImageDiv = document.createElement("div");
        logoImageDiv.classList.add("logo-image");

        const img = document.createElement("img");
        img.src = logo.src;
        img.alt = logo.alt;
        img.classList.add("logo-vector");

        const span = document.createElement("span");
        span.textContent = logo.name;

        logoImageDiv.appendChild(img);
        logoBlock.appendChild(logoImageDiv);
        logoBlock.appendChild(span);
        grid.appendChild(logoBlock);
      });
    };

    // Initial render for desktop
    if (window.innerWidth >= 960) {
      renderLogos(initialCat, integrationLogosGrid);
    }

    const handleInteraction = (event) => {
      // For mobile, only respond to clicks
      if (window.innerWidth < 960 && event.type !== "click") {
        return;
      }

      listItems.forEach((li) => li.classList.remove("active"));
      const target = event.currentTarget;
      if (target instanceof HTMLElement) {
        target.classList.add("active");

        const index = target.dataset.index;
        if (index !== undefined) {
          const category = categories[parseInt(index)];
          if (category) {
            if (window.innerWidth < 960) {
              // Mobile: render in modal and show it
              renderLogos(category, integrationLogosGridMobile);
              modal.style.display = "flex";
            } else {
              // Desktop: render in main grid
              renderLogos(category, integrationLogosGrid);
            }
          }
        }
      }
    };

    listItems.forEach((item) => {
      // We add both listeners and let the handler decide the action
      item.addEventListener("mouseenter", handleInteraction);
      item.addEventListener("click", handleInteraction);
    });

    closeModal.addEventListener("click", () => {
      modal.style.display = "none";
    });

    window.addEventListener("click", (event) => {
      if (event.target == modal) {
        modal.style.display = "none";
      }
    });

    // Handle resize to switch between desktop/mobile logic
    let resizeTimeout;
    window.addEventListener("resize", () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        // Re-render initial category on resize to ensure correct view is shown
        if (window.innerWidth >= 960) {
          renderLogos(initialCat, integrationLogosGrid);
          modal.style.display = "none"; // Hide modal on resize to desktop
        } else {
          integrationLogosGrid.innerHTML = ""; // Clear desktop grid on resize to mobile
        }
      }, 250);
    });
  }
</script>

<style is:global>
  /* Modal Styles */
  .integrations-modal {
    display: none; /* Hidden by default */
    position: fixed;
    align-items: center;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.8);
  }

  .integrations-modal-content {
    background-color: var(--color-background);
    margin: 5% auto;
    padding: 20px;
    border: var(--border);
    border-radius: clamp(1rem, 1.5cqw, 8rem);
    width: 90%;
    max-width: 600px;
    position: relative;
  }

  .integrations-modal-close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    line-height: 1;
  }

  .integrations-modal-close:hover,
  .integrations-modal-close:focus {
    color: white;
    text-decoration: none;
    cursor: pointer;
  }

  /* General Styles */
  .logo-block span {
    font-size: max(0.7em, 0.9cqw);
    color: white;
    font-weight: var(--font-weight-light);
    display: none;
  }
  .highlight-main-title {
    margin-bottom: 0;
  }
  .integrations-section {
    padding: 14cqb var(--space-xxl);
  }
  .highlight-content {
    display: flex;
    flex-direction: column;
    gap: 2cqw;
  }

  .highlight-image-container {
    position: relative;
    width: 100%;
    transition: box-shadow 0.3s ease;
    display: flex;
    align-items: center;
  }

  .integration-logos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(13cqb, 1fr));
    align-content: center;
    gap: 1cqb;
    width: 100%;
    height: 100%;
    align-items: center;
    justify-content: center;
    overflow-y: auto;
    z-index: 2;
    opacity: 1;
    transition: opacity 0.5s ease-in-out;
  }

  .logo-block {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 1cqw;
    background-color: rgba(255, 255, 255, 0.05);
    border: var(--border);
    border-radius: clamp(1rem, 1.5cqw, 8rem);
  }

  .logo-image {
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .logo-vector {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }

  .highlight-details {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 1em;
  }

  .highlight-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .highlight-list li {
    position: relative;
    font-size: max(1.4em, 2cqw);
    line-height: 1.8;
    color: var(--color-link);
    cursor: pointer;
    transition: color 0.3s ease;
    padding-bottom: 0.2em;
    width: max-content;
    font-weight: 220;
    color: hsl(0, 0%, 80%);
  }

  .highlight-list li::before {
    content: "";
    position: absolute;
    bottom: 0;
    right: 0%;
    width: 0;
    height: 0.1cqw;
    background-color: hsla(38, 70%, 62%, 1);
    transition: width 0.3s ease;
  }

  .highlight-list li:hover,
  .highlight-list li.active {
    color: var(--color-blue);
  }

  .highlight-list li:hover::before,
  .highlight-list li.active::before {
    width: 100%;
  }

  /* Mobile Styles */
  @media (max-width: 960px) {
    .desktop-only {
      display: none;
    }
    .mobile-only {
      display: none; /* Modal is hidden by default, shown via script */
    }
    #integration-logos-grid-mobile {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(9cqb, 1fr));
      gap: 1cqb;
      margin-top: 6cqb;
    }
  }

  /* Desktop Styles */
  @media (min-width: 960px) {
    .mobile-only {
      display: none !important; /* Ensure modal is never shown on desktop */
    }
    .desktop-only {
      display: flex;
    }
    .highlight-content {
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
    }
    .highlight-image-container {
      width: 50%;
      z-index: 1;
      background: var(--color-background);
      height: -webkit-fill-available;
    }
    .highlight-details {
      width: 45%;
    }
  }
</style>
